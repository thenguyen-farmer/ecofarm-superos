<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EcoFarm Mobile Pro</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --app-bg: #f0f2f5;
            --primary: #2e7d32;
            --nav-height: 60px;
        }
        body {
            background-color: var(--app-bg);
            padding-bottom: calc(var(--nav-height) + 20px); /* Space for bottom nav */
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        /* Mobile Card */
        .glass-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            padding: 15px;
            margin-bottom: 15px;
            border: none;
        }

        /* Fixed Bottom Nav */
        .bottom-nav {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            height: var(--nav-height);
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-btn {
            border: none; background: none;
            color: #999;
            font-size: 12px;
            display: flex; flex-direction: column; align-items: center;
        }
        .nav-btn.active { color: var(--primary); font-weight: bold; }
        .nav-btn i { font-size: 20px; margin-bottom: 2px; }

        /* Header */
        .app-header {
            position: sticky; top: 0;
            background: white;
            z-index: 900;
            padding: 10px 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 15px;
            display: flex; justify-content: space-between; align-items: center;
        }

        #map { height: 70vh; border-radius: 12px; }
        
        /* Chat UI */
        .chat-box { height: 60vh; overflow-y: auto; background: #f8f9fa; border-radius: 12px; padding: 10px; }
        .chat-msg { max-width: 85%; padding: 10px; border-radius: 15px; margin-bottom: 8px; font-size: 14px; }
        .chat-user { background: #d1e7dd; margin-left: auto; border-bottom-right-radius: 2px; }
        .chat-bot { background: white; border: 1px solid #eee; border-bottom-left-radius: 2px; }

        #loading-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: white; z-index: 9999;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="spinner-border text-success" role="status"></div>
        <div class="mt-3 text-muted fw-bold">EcoFarm Mobile</div>
    </div>

    <!-- Header -->
    <div class="app-header">
        <h5 class="m-0 text-success fw-bold"><i class="fas fa-leaf"></i> EcoFarm</h5>
        <button class="btn btn-sm btn-light text-muted" onclick="location.reload()"><i class="fas fa-sync"></i></button>
    </div>

    <div class="container-fluid">
        <!-- Content Area -->
        <div class="tab-content" id="mainTabContent">
            <!-- 1. DASHBOARD -->
            <div class="tab-pane fade show active" id="home">
                <!-- Stats Row -->
                <div class="row g-2 mb-3">
                    <div class="col-4">
                        <div class="glass-card text-center p-2 h-100">
                            <small class="text-muted">Cây Trồng</small>
                            <h4 id="stat-tree" class="text-success m-0 fw-bold">0</h4>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="glass-card text-center p-2 h-100">
                            <small class="text-muted">Nhân Sự</small>
                            <h4 id="stat-staff" class="text-primary m-0 fw-bold">0</h4>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="glass-card text-center p-2 h-100 bg-danger text-white" onclick="$('#mainTab button[data-bs-target=\'#hrm\']').click(); switchTab(document.querySelector('.nav-btn[data-bs-target=\'#hrm\']'))">
                            <small>Nợ Lương</small>
                            <h5 id="stat-salary-debt" class="m-0 fw-bold">0</h5>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="glass-card mb-3">
                    <h6 class="text-muted mb-2">TRUY CẬP NHANH</h6>
                    <div class="d-flex justify-content-around">
                        <button class="btn btn-outline-primary rounded-circle p-3" onclick="switchTab(document.querySelector('.nav-btn[data-bs-target=\'#hrm\']'))"><i class="fas fa-user-check fa-lg"></i></button>
                        <button class="btn btn-outline-success rounded-circle p-3" onclick="switchTab(document.querySelector('.nav-btn[data-bs-target=\'#finance\']'))"><i class="fas fa-plus fa-lg"></i></button>
                        <button class="btn btn-outline-info rounded-circle p-3" onclick="switchTab(document.querySelector('.nav-btn[data-bs-target=\'#chat\']'))"><i class="fas fa-camera fa-lg"></i></button>
                    </div>
                    <div class="d-flex justify-content-around small text-muted mt-1">
                        <span>Chấm công</span>
                        <span>Thu/Chi</span>
                        <span>Soi bệnh</span>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-8">
                         <div class="glass-card mb-3">
                            <h5><i class="fas fa-chart-bar"></i> Tài Chính Tháng</h5>
                            <canvas id="financeChart" style="height:200px"></canvas>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="glass-card mb-3">
                            <h5><i class="fas fa-tasks"></i> Việc Hôm Nay</h5>
                            <ul id="today-tasks" class="list-group list-group-flush small"></ul>
                        </div>
                        <div class="glass-card mt-3">
                            <h5 class="text-info"><i class="fas fa-map-signs"></i> Chú Thích Map</h5>
                            <div class="small">
                                <span class="badge bg-success">Tốt</span>
                                <span class="badge bg-danger">Bệnh</span>
                                <span class="badge bg-primary">Cần nước</span>
                                <span class="badge bg-warning text-dark">Thu hoạch</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. MAP -->
            <div class="tab-pane fade" id="map-view">
                <div class="glass-card">
                    <div id="map"></div>
                </div>
            </div>

            <!-- 3. HRM -->
            <div class="tab-pane fade" id="hrm">
                <div class="row">
                    <div class="col-md-5">
                        <div class="glass-card">
                            <h5><i class="fas fa-user-check"></i> Chấm Công Nhanh</h5>
                            <div class="mb-2"><input type="date" id="checkin-date" class="form-control"></div>
                            <div class="mb-2">
                                <label>Công việc</label>
                                <select id="checkin-job" class="form-select"></select>
                            </div>
                            <div class="row mb-2">
                                <div class="col"><input type="number" id="checkin-bonus" class="form-control" placeholder="Thưởng"></div>
                                <div class="col"><input type="number" id="checkin-fine" class="form-control" placeholder="Phạt"></div>
                            </div>
                            <div class="mb-2">
                                <label>Đánh giá (1-5 sao) & Ghi chú</label>
                                <div class="input-group">
                                    <select id="checkin-rating" class="form-select" style="max-width: 80px;">
                                        <option value="5">5★</option><option value="4">4★</option><option value="3">3★</option><option value="2">2★</option><option value="1">1★</option>
                                    </select>
                                    <input type="text" id="checkin-note" class="form-control" placeholder="Ghi chú công việc...">
                                </div>
                            </div>
                            <div class="mb-3 border p-2 rounded bg-white" style="max-height: 150px; overflow-y: auto;" id="checkin-staff-list"></div>
                            <button class="btn btn-success w-100" onclick="HRMModule.submitBulkCheckin()">Lưu & Tính Lương</button>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div class="glass-card">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5>Bảng Lương Tháng</h5>
                                <input type="month" id="salary-month" class="form-control w-auto" onchange="HRMModule.renderSalaryReport()">
                            </div>
                            <div class="table-responsive">
                                <table class="table table-sm table-striped" id="table-salary-report">
                                    <thead><tr><th>Nhân Viên</th><th>Công</th><th>Thưởng/Phạt</th><th>Thực Lĩnh</th><th>Trạng Thái</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="glass-card mt-3">
                            <h5>Lịch Sử Chấm Công Gần Nhất</h5>
                            <table class="table table-sm" id="table-attendance">
                                <thead><tr><th>Ngày</th><th>Tên</th><th>Việc</th><th>Tổng</th><th>TT</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 4. FINANCE -->
             <div class="tab-pane fade" id="finance">
                <div class="row">
                    <div class="col-md-4">
                        <div class="glass-card">
                            <h5>Giao Dịch Mới</h5>
                            <ul class="nav nav-tabs mb-2">
                                <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#f-expense">Chi Phí</a></li>
                                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#f-salary">Trả Lương</a></li>
                                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#f-revenue">Nguồn Thu</a></li>
                            </ul>
                            <div class="tab-content">
                                <!-- Expense Form -->
                                <div class="tab-pane active" id="f-expense">
                                    <div class="mb-2"><label>Ngày</label><input type="date" id="expense-date" class="form-control"></div>
                                    <div class="mb-2"><label>Hạng Mục</label><select id="expense-type" class="form-select"></select></div>
                                    <div class="row mb-2">
                                        <div class="col"><input type="number" id="expense-qty" class="form-control" placeholder="SL"></div>
                                        <div class="col"><input type="number" id="expense-price" class="form-control" placeholder="Đơn giá"></div>
                                    </div>
                                    <div class="mb-2"><input type="number" id="expense-amount-manual" class="form-control" placeholder="Hoặc nhập Tổng tiền"></div>
                                    <div class="mb-2"><input type="text" id="expense-note" class="form-control" placeholder="Ghi chú"></div>
                                    <button class="btn btn-danger w-100" onclick="FinanceModule.submitExpense()">Lưu Phiếu Chi</button>
                                </div>
                                <!-- Salary Form -->
                                <div class="tab-pane" id="f-salary">
                                    <div class="mb-2"><select id="salary-staff" class="form-select" onchange="HRMModule.checkUnpaidSalary()"></select></div>
                                    <div id="salary-info" class="alert alert-info p-2">Chọn NV để xem nợ.</div>
                                    <button id="btn-pay-salary" class="btn btn-primary w-100" disabled onclick="HRMModule.paySalary()">Thanh Toán Lương</button>
                                </div>
                                <!-- Revenue Form -->
                                <div class="tab-pane" id="f-revenue">
                                    <div class="mb-2"><label>Nông Sản</label><input type="text" id="rev-type" class="form-control"></div>
                                    <div class="row mb-2">
                                        <div class="col"><input type="number" id="rev-qty" class="form-control" placeholder="Kg"></div>
                                        <div class="col"><input type="number" id="rev-price" class="form-control" placeholder="Đơn giá"></div>
                                    </div>
                                    <button class="btn btn-success w-100" onclick="FinanceModule.submitRevenue()">Lưu Doanh Thu</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="glass-card">
                            <h5>Lịch Sử Tài Chính</h5>
                            <table class="table table-sm" id="table-finance">
                                <thead><tr><th>Ngày</th><th>Loại</th><th>Mục</th><th>Tiền</th><th>Ghi Chú</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 5. CHATBOT -->
            <div class="tab-pane fade" id="chat">
                <div class="glass-card">
                    <h5><i class="fas fa-robot"></i> Trợ Lý Nông Nghiệp AI (Gemini Vision)</h5>
                    <div id="chat-history" class="chat-box mb-3"></div>
                    <div class="input-group">
                        <label class="btn btn-secondary">
                            <i class="fas fa-camera"></i> <input type="file" id="chat-img" accept="image/*" hidden onchange="ChatbotModule.previewImage()">
                        </label>
                        <input type="text" id="chat-input" class="form-control" placeholder="Hỏi hoặc gửi ảnh bệnh cây...">
                        <button class="btn btn-success" onclick="ChatbotModule.sendChat()">Gửi</button>
                    </div>
                    <div id="chat-preview" class="mt-2" style="display:none">
                        <img id="img-preview" src="" height="60" class="rounded border">
                        <button class="btn btn-sm btn-danger rounded-circle" onclick="ChatbotModule.clearImage()">x</button>
                    </div>
                </div>
            </div>

            <!-- 6. CONFIG -->
            <div class="tab-pane fade" id="config">
                <div class="glass-card">
                    <h5 class="mb-3 text-muted">QUẢN LÝ HỆ THỐNG</h5>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary text-start" onclick="$('#cfg-staff').toggle()"><i class="fas fa-users-cog me-2"></i> Nhân Sự</button>
                        <div id="cfg-staff" style="display:none">
                            <button class="btn btn-sm btn-primary mb-2 w-100" onclick="ConfigModule.addStaff()">+ Thêm Nhân Viên</button>
                            <table class="table table-sm" id="table-staff"><thead><tr><th>Tên</th><th>SĐT</th><th>#</th></tr></thead><tbody></tbody></table>
                        </div>

                        <button class="btn btn-outline-success text-start" onclick="$('#cfg-jobs').toggle()"><i class="fas fa-briefcase me-2"></i> Công Việc</button>
                        <div id="cfg-jobs" style="display:none">
                            <button class="btn btn-sm btn-success mb-2 w-100" onclick="ConfigModule.addJob()">+ Thêm Công Việc</button>
                            <table class="table table-sm" id="table-jobs"><thead><tr><th>Việc</th><th>Giá</th><th>#</th></tr></thead><tbody></tbody></table>
                        </div>

                        <button class="btn btn-outline-warning text-start" onclick="$('#cfg-exps').toggle()"><i class="fas fa-coins me-2"></i> Loại Chi Phí</button>
                        <div id="cfg-exps" style="display:none">
                            <button class="btn btn-sm btn-warning mb-2 w-100" onclick="ConfigModule.addExpense()">+ Thêm Loại Chi</button>
                            <table class="table table-sm" id="table-expenses"><thead><tr><th>Loại</th><th>Nhóm</th><th>#</th></tr></thead><tbody></tbody></table>
                        </div>

                        <button class="btn btn-outline-info text-start" onclick="ConfigModule.addKnowledge()"><i class="fas fa-book me-2"></i> Thêm Tri Thức AI</button>
                        
                        <div class="mt-3 border-top pt-2">
                            <label class="small text-muted">Cấu Hình AI System Prompt</label>
                            <textarea id="bot-system-prompt" class="form-control mb-2" rows="3" placeholder="VD: Bạn là chuyên gia nông nghiệp..."></textarea>
                            <button class="btn btn-sm btn-dark w-100" onclick="ChatbotModule.updateSettings()">Lưu Prompt</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fixed Bottom Navigation -->
    <div class="bottom-nav">
        <button class="nav-btn active" data-bs-toggle="pill" data-bs-target="#home" onclick="switchTab(this)"><i class="fas fa-home"></i><span>Home</span></button>
        <button class="nav-btn" data-bs-toggle="pill" data-bs-target="#map-view" onclick="switchTab(this)"><i class="fas fa-map"></i><span>Map</span></button>
        <button class="nav-btn" data-bs-toggle="pill" data-bs-target="#hrm" onclick="switchTab(this)"><i class="fas fa-users"></i><span>HRM</span></button>
        <button class="nav-btn" data-bs-toggle="pill" data-bs-target="#finance" onclick="switchTab(this)"><i class="fas fa-coins"></i><span>Tiền</span></button>
        <button class="nav-btn" data-bs-toggle="pill" data-bs-target="#chat" onclick="switchTab(this)"><i class="fas fa-robot"></i><span>Bot</span></button>
        <button class="nav-btn" data-bs-toggle="pill" data-bs-target="#config" onclick="switchTab(this)"><i class="fas fa-cogs"></i><span>Cấu hình</span></button>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> <!-- Modern Alerts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Modules -->
    <script src="js/config.js"></script>
    <script src="js/modules/core.js"></script>
    <script src="js/modules/dashboard.js"></script>
    <script src="js/modules/map.js"></script>
    <script src="js/modules/hrm.js"></script>
    <script src="js/modules/finance.js"></script>
    <script src="js/modules/chatbot.js"></script>
    <script src="js/modules/settings.js"></script>
    
    <!-- Main Entry -->
    <script src="js/app.js"></script>

    <script>
        function switchTab(btn) {
            // 1. Visual Active State
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // 2. Trigger Bootstrap Tab Switch
            const targetSelector = btn.getAttribute('data-bs-target');
            const targetPane = document.querySelector(targetSelector);
            
            // Standard Bootstrap 5 Tab trigger
            // We find the trigger element corresponding to this target if it exists, or create a virtual one
            // Simpler: Just remove .active/.show from all panes and add to target
            document.querySelectorAll('.tab-pane').forEach(p => {
                p.classList.remove('show', 'active');
            });
            targetPane.classList.add('show', 'active');
            
            // Special Case: Resize Map if opening map tab
            if (targetSelector === '#map-view' && typeof mapInstance !== 'undefined') {
                setTimeout(() => mapInstance.invalidateSize(), 200);
            }
        }
    </script>
</body>
</html>
