<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EcoFarm Mobile Pro</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --app-bg: #f0f2f5;
            --primary: #2e7d32;
            --nav-height: 60px;
        }
        body {
            background-color: var(--app-bg);
            padding-bottom: calc(var(--nav-height) + 20px); /* Space for bottom nav */
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        /* Mobile Card */
        .glass-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            padding: 15px;
            margin-bottom: 15px;
            border: none;
        }

        /* Fixed Bottom Nav */
        .bottom-nav {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            height: var(--nav-height);
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-btn {
            border: none; background: none;
            color: #999;
            font-size: 12px;
            display: flex; flex-direction: column; align-items: center;
        }
        .nav-btn.active { color: var(--primary); font-weight: bold; }
        .nav-btn i { font-size: 20px; margin-bottom: 2px; }

        /* Header */
        .app-header {
            position: sticky; top: 0;
            background: white;
            z-index: 900;
            padding: 10px 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 15px;
            display: flex; justify-content: space-between; align-items: center;
        }

        #map { height: 70vh; border-radius: 12px; }
        
        /* Chat UI */
        .chat-box { height: 60vh; overflow-y: auto; background: #f8f9fa; border-radius: 12px; padding: 10px; }
        .chat-msg { max-width: 85%; padding: 10px; border-radius: 15px; margin-bottom: 8px; font-size: 14px; }
        .chat-user { background: #d1e7dd; margin-left: auto; border-bottom-right-radius: 2px; }
        .chat-bot { background: white; border: 1px solid #eee; border-bottom-left-radius: 2px; }

        #loading-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: white; z-index: 9999;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="spinner-border text-success" role="status"></div>
        <div class="mt-3 text-muted fw-bold">EcoFarm Mobile</div>
    </div>

    <!-- Header -->
    <div class="app-header">
        <h5 class="m-0 text-success fw-bold"><i class="fas fa-leaf"></i> EcoFarm</h5>
        <button class="btn btn-sm btn-light text-muted" onclick="location.reload()"><i class="fas fa-sync"></i></button>
    </div>

    <div class="container-fluid">
        <!-- Content Area -->
        <div class="tab-content" id="mainTabContent">
            <!-- 1. DASHBOARD -->
            <div class="tab-pane fade show active" id="home">
                <!-- Stats Row -->
                <div class="row g-2 mb-3">
                    <div class="col-4">
                        <div class="glass-card text-center p-2 h-100">
                            <small class="text-muted">C√¢y Tr·ªìng</small>
                            <h4 id="stat-tree" class="text-success m-0 fw-bold">0</h4>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="glass-card text-center p-2 h-100">
                            <small class="text-muted">Nh√¢n S·ª±</small>
                            <h4 id="stat-staff" class="text-primary m-0 fw-bold">0</h4>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="glass-card text-center p-2 h-100 bg-danger text-white" onclick="$('#mainTab button[data-bs-target=\'#hrm\']').click(); switchTab(document.querySelector('.nav-btn[data-bs-target=\'#hrm\']'))">
                            <small>N·ª£ L∆∞∆°ng</small>
                            <h5 id="stat-salary-debt" class="m-0 fw-bold">0</h5>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="glass-card mb-3">
                    <h6 class="text-muted mb-2">TRUY C·∫¨P NHANH</h6>
                    <div class="d-flex justify-content-around">
                        <button class="btn btn-outline-primary rounded-circle p-3" onclick="switchTab(document.querySelector('.nav-btn[data-bs-target=\'#hrm\']'))"><i class="fas fa-user-check fa-lg"></i></button>
                        <button class="btn btn-outline-success rounded-circle p-3" onclick="switchTab(document.querySelector('.nav-btn[data-bs-target=\'#finance\']'))"><i class="fas fa-plus fa-lg"></i></button>
                        <button class="btn btn-outline-info rounded-circle p-3" onclick="switchTab(document.querySelector('.nav-btn[data-bs-target=\'#chat\']'))"><i class="fas fa-camera fa-lg"></i></button>
                    </div>
                    <div class="d-flex justify-content-around small text-muted mt-1">
                        <span>Ch·∫•m c√¥ng</span>
                        <span>Thu/Chi</span>
                        <span>Soi b·ªánh</span>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-8">
                         <div class="glass-card mb-3">
                            <h5><i class="fas fa-chart-bar"></i> T√†i Ch√≠nh Th√°ng</h5>
                            <div style="height: 250px; position: relative;">
                                <canvas id="financeChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="glass-card mb-3">
                            <h5><i class="fas fa-cloud-sun"></i> Th·ªùi Ti·∫øt</h5>
                            <div id="weather-widget">Loading weather...</div>
                        </div>
                        <div class="glass-card mb-3">
                            <h5><i class="fas fa-tasks"></i> Vi·ªác H√¥m Nay</h5>
                            <ul id="today-tasks" class="list-group list-group-flush small"></ul>
                        </div>
                        <div class="glass-card mt-3">
                            <h5 class="text-info"><i class="fas fa-map-signs"></i> Ch√∫ Th√≠ch Map</h5>
                            <div class="small">
                                <span class="badge bg-success">T·ªët</span>
                                <span class="badge bg-danger">B·ªánh</span>
                                <span class="badge bg-primary">C·∫ßn n∆∞·ªõc</span>
                                <span class="badge bg-warning text-dark">Thu ho·∫°ch</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. MAP -->
            <div class="tab-pane fade" id="map-view">
                <div class="glass-card p-0 overflow-hidden">
                    <div class="d-flex justify-content-between align-items-center p-2 bg-light border-bottom overflow-auto">
                        <div class="d-flex gap-2">
                            <button id="btn-bulk-mode" class="btn btn-sm btn-outline-primary text-nowrap" onclick="MapModule.toggleBulkMode()"><i class="fas fa-magic"></i> Th√™m Nhanh</button>
                            <select id="map-type-select" class="form-select form-select-sm" style="width: auto;">
                                <option value="S·∫ßu ri√™ng">S·∫ßu ri√™ng</option>
                                <option value="C√† ph√™">C√† ph√™</option>
                                <option value="ƒêi·ªÅu">ƒêi·ªÅu</option>
                                <option value="D·ª´a">D·ª´a</option>
                                <option value="B∆°">B∆°</option>
                                <option value="Ti√™u">Ti√™u</option>
                                <option value="T·ªß ƒëi·ªán">‚ö° T·ªß ƒëi·ªán</option>
                                <option value="·ªêng n∆∞·ªõc">üíß ·ªêng n∆∞·ªõc</option>
                            </select>
                        </div>
                        <button class="btn btn-sm btn-outline-secondary ms-2 text-nowrap" onclick="MapModule.toggleListView()"><i class="fas fa-list"></i> List</button>
                    </div>
                    
                    <!-- Map Container -->
                    <div id="map-container" style="height: 70vh;">
                        <div id="map" style="height: 100%; width: 100%;"></div>
                    </div>

                    <!-- List View Container (Hidden) -->
                    <div id="tree-list-container" style="height: 70vh; overflow-y: auto; display: none;" class="p-2">
                        <table class="table table-sm table-striped" id="table-trees">
                            <thead class="sticky-top bg-white"><tr><th>Lo·∫°i</th><th>Tr·∫°ng Th√°i</th><th>#</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 3. HRM -->
            <div class="tab-pane fade" id="hrm">
                <div class="row">
                    <div class="col-md-5">
                        <div class="glass-card">
                            <h5><i class="fas fa-user-check"></i> Ch·∫•m C√¥ng Nhanh</h5>
                            <div class="mb-2"><input type="date" id="checkin-date" class="form-control"></div>
                            <div class="mb-2">
                                <label>C√¥ng vi·ªác</label>
                                <select id="checkin-job" class="form-select"></select>
                            </div>
                            <div class="row mb-2">
                                <div class="col"><input type="number" id="checkin-bonus" class="form-control" placeholder="Th∆∞·ªüng"></div>
                                <div class="col"><input type="number" id="checkin-fine" class="form-control" placeholder="Ph·∫°t"></div>
                            </div>
                            <div class="mb-2">
                                <label>ƒê√°nh gi√° (1-5 sao) & Ghi ch√∫</label>
                                <div class="input-group">
                                    <select id="checkin-rating" class="form-select" style="max-width: 80px;">
                                        <option value="5">5‚òÖ</option><option value="4">4‚òÖ</option><option value="3">3‚òÖ</option><option value="2">2‚òÖ</option><option value="1">1‚òÖ</option>
                                    </select>
                                    <input type="text" id="checkin-note" class="form-control" placeholder="Ghi ch√∫ c√¥ng vi·ªác...">
                                </div>
                            </div>
                            <div class="mb-3 border p-2 rounded bg-white" style="max-height: 150px; overflow-y: auto;" id="checkin-staff-list"></div>
                            <button class="btn btn-success w-100" onclick="HRMModule.submitBulkCheckin()">L∆∞u & T√≠nh L∆∞∆°ng</button>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div class="glass-card">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5>B·∫£ng L∆∞∆°ng Th√°ng</h5>
                                <input type="month" id="salary-month" class="form-control w-auto" onchange="HRMModule.renderSalaryReport()">
                            </div>
                            <div class="table-responsive">
                                <table class="table table-sm table-striped" id="table-salary-report">
                                    <thead><tr><th>Nh√¢n Vi√™n</th><th>C√¥ng</th><th>Th∆∞·ªüng/Ph·∫°t</th><th>Th·ª±c Lƒ©nh</th><th>Tr·∫°ng Th√°i</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="glass-card mt-3">
                            <h5>L·ªãch S·ª≠ Ch·∫•m C√¥ng G·∫ßn Nh·∫•t</h5>
                            <table class="table table-sm" id="table-attendance">
                                <thead><tr><th>Ng√†y</th><th>T√™n</th><th>Vi·ªác</th><th>T·ªïng</th><th>TT</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 4. FINANCE -->
             <div class="tab-pane fade" id="finance">
                <div class="row">
                    <div class="col-md-4">
                        <div class="glass-card">
                            <h5>Giao D·ªãch M·ªõi</h5>
                            <ul class="nav nav-tabs mb-2">
                                <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#f-expense">Chi Ph√≠</a></li>
                                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#f-salary">Tr·∫£ L∆∞∆°ng</a></li>
                                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#f-revenue">Ngu·ªìn Thu</a></li>
                            </ul>
                            <div class="tab-content">
                                <!-- Expense Form -->
                                <div class="tab-pane active" id="f-expense">
                                    <div class="mb-2"><label>Ng√†y</label><input type="date" id="expense-date" class="form-control"></div>
                                    <div class="mb-2"><label>H·∫°ng M·ª•c</label><select id="expense-type" class="form-select"></select></div>
                                    <div class="row mb-2">
                                        <div class="col"><input type="number" id="expense-qty" class="form-control" placeholder="SL"></div>
                                        <div class="col"><input type="number" id="expense-price" class="form-control" placeholder="ƒê∆°n gi√°"></div>
                                    </div>
                                    <div class="mb-2"><input type="number" id="expense-amount-manual" class="form-control" placeholder="Ho·∫∑c nh·∫≠p T·ªïng ti·ªÅn"></div>
                                    <div class="mb-2"><input type="text" id="expense-note" class="form-control" placeholder="Ghi ch√∫"></div>
                                    <button class="btn btn-danger w-100" onclick="FinanceModule.submitExpense()">L∆∞u Phi·∫øu Chi</button>
                                </div>
                                <!-- Salary Form -->
                                <div class="tab-pane" id="f-salary">
                                    <div class="mb-2"><select id="salary-staff" class="form-select" onchange="HRMModule.checkUnpaidSalary()"></select></div>
                                    <div id="salary-info" class="alert alert-info p-2">Ch·ªçn NV ƒë·ªÉ xem n·ª£.</div>
                                    <button id="btn-pay-salary" class="btn btn-primary w-100" disabled onclick="HRMModule.paySalary()">Thanh To√°n L∆∞∆°ng</button>
                                </div>
                                <!-- Revenue Form -->
                                <div class="tab-pane" id="f-revenue">
                                    <div class="mb-2"><label>Ng√†y</label><input type="date" id="rev-date" class="form-control"></div>
                                    <div class="mb-2"><label>N√¥ng S·∫£n</label><input type="text" id="rev-type" class="form-control"></div>
                                    <div class="row mb-2">
                                        <div class="col"><input type="number" id="rev-qty" class="form-control" placeholder="Kg"></div>
                                        <div class="col"><input type="number" id="rev-price" class="form-control" placeholder="ƒê∆°n gi√°"></div>
                                    </div>
                                    <button class="btn btn-success w-100" onclick="FinanceModule.submitRevenue()">L∆∞u Doanh Thu</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="glass-card">
                            <h5>L·ªãch S·ª≠ T√†i Ch√≠nh</h5>
                            <table class="table table-sm" id="table-finance">
                                <thead><tr><th>Ng√†y</th><th>Lo·∫°i</th><th>M·ª•c</th><th>Ti·ªÅn</th><th>Ghi Ch√∫</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 5. CHATBOT -->
            <div class="tab-pane fade" id="chat">
                <div class="glass-card">
                    <h5><i class="fas fa-robot"></i> Tr·ª£ L√Ω N√¥ng Nghi·ªáp AI (Gemini Vision)</h5>
                    <div id="chat-history" class="chat-box mb-3"></div>
                    <div class="input-group">
                        <label class="btn btn-secondary">
                            <i class="fas fa-camera"></i> <input type="file" id="chat-img" accept="image/*" hidden onchange="ChatbotModule.previewImage()">
                        </label>
                        <input type="text" id="chat-input" class="form-control" placeholder="H·ªèi ho·∫∑c g·ª≠i ·∫£nh b·ªánh c√¢y...">
                        <button class="btn btn-success" onclick="ChatbotModule.sendChat()">G·ª≠i</button>
                    </div>
                    <div id="chat-preview" class="mt-2" style="display:none">
                        <img id="img-preview" src="" height="60" class="rounded border">
                        <button class="btn btn-sm btn-danger rounded-circle" onclick="ChatbotModule.clearImage()">x</button>
                    </div>
                </div>
            </div>

            <!-- 6. CONFIG -->
            <div class="tab-pane fade" id="config">
                <div class="glass-card">
                    <h5 class="mb-3 text-muted">QU·∫¢N L√ù H·ªÜ TH·ªêNG</h5>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary text-start" onclick="$('#cfg-staff').toggle()"><i class="fas fa-users-cog me-2"></i> Nh√¢n S·ª±</button>
                        <div id="cfg-staff" style="display:none">
                            <button class="btn btn-sm btn-primary mb-2 w-100" onclick="ConfigModule.addStaff()">+ Th√™m Nh√¢n Vi√™n</button>
                            <table class="table table-sm" id="table-staff"><thead><tr><th>T√™n</th><th>SƒêT</th><th>#</th></tr></thead><tbody></tbody></table>
                        </div>

                        <button class="btn btn-outline-success text-start" onclick="$('#cfg-jobs').toggle()"><i class="fas fa-briefcase me-2"></i> C√¥ng Vi·ªác</button>
                        <div id="cfg-jobs" style="display:none">
                            <button class="btn btn-sm btn-success mb-2 w-100" onclick="ConfigModule.addJob()">+ Th√™m C√¥ng Vi·ªác</button>
                            <table class="table table-sm" id="table-jobs"><thead><tr><th>Vi·ªác</th><th>Gi√°</th><th>#</th></tr></thead><tbody></tbody></table>
                        </div>

                        <button class="btn btn-outline-warning text-start" onclick="$('#cfg-exps').toggle()"><i class="fas fa-coins me-2"></i> Lo·∫°i Chi Ph√≠</button>
                        <div id="cfg-exps" style="display:none">
                            <button class="btn btn-sm btn-warning mb-2 w-100" onclick="ConfigModule.addExpense()">+ Th√™m Lo·∫°i Chi</button>
                            <table class="table table-sm" id="table-expenses"><thead><tr><th>Lo·∫°i</th><th>Nh√≥m</th><th>#</th></tr></thead><tbody></tbody></table>
                        </div>

                        <button class="btn btn-outline-info text-start" onclick="$('#cfg-know').toggle()"><i class="fas fa-book me-2"></i> Kho Tri Th·ª©c AI</button>
                        <div id="cfg-know" style="display:none">
                            <button class="btn btn-sm btn-info mb-2 w-100 text-white" onclick="ConfigModule.addKnowledge()">+ Th√™m H·ªèi/ƒê√°p</button>
                            <table class="table table-sm" id="table-knowledge"><thead><tr><th>T·ª´ Kh√≥a</th><th>Tr·∫£ L·ªùi</th><th>#</th></tr></thead><tbody></tbody></table>
                        </div>
                        
                        <div class="mt-3 border-top pt-2">
                            <label class="small text-muted">C·∫•u H√¨nh AI System Prompt</label>
                            <textarea id="bot-system-prompt" class="form-control mb-2" rows="3" placeholder="VD: B·∫°n l√† chuy√™n gia n√¥ng nghi·ªáp..."></textarea>
                            <button class="btn btn-sm btn-dark w-100" onclick="ChatbotModule.updateSettings()">L∆∞u Prompt</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fixed Bottom Navigation -->
    <div class="bottom-nav">
        <button class="nav-btn active" data-bs-toggle="pill" data-bs-target="#home" onclick="switchTab(this)"><i class="fas fa-home"></i><span>Home</span></button>
        <button class="nav-btn" data-bs-toggle="pill" data-bs-target="#map-view" onclick="switchTab(this)"><i class="fas fa-map"></i><span>Map</span></button>
        <button class="nav-btn" data-bs-toggle="pill" data-bs-target="#hrm" onclick="switchTab(this)"><i class="fas fa-users"></i><span>HRM</span></button>
        <button class="nav-btn" data-bs-toggle="pill" data-bs-target="#finance" onclick="switchTab(this)"><i class="fas fa-coins"></i><span>Ti·ªÅn</span></button>
        <button class="nav-btn" data-bs-toggle="pill" data-bs-target="#chat" onclick="switchTab(this)"><i class="fas fa-robot"></i><span>Bot</span></button>
        <button class="nav-btn" data-bs-toggle="pill" data-bs-target="#config" onclick="switchTab(this)"><i class="fas fa-cogs"></i><span>C·∫•u h√¨nh</span></button>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> <!-- Modern Alerts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Modules -->
    <script src="js/config.js"></script>
    <script src="js/modules/core.js"></script>
    <script src="js/modules/dashboard.js"></script>
    <script src="js/modules/map.js"></script>
    <script src="js/modules/hrm.js"></script>
    <script src="js/modules/finance.js"></script>
    <script src="js/modules/chatbot.js"></script>
    <script src="js/modules/settings.js"></script>
    
    <!-- Main Entry -->
    <script src="js/app.js"></script>

    <script>
        function switchTab(btn) {
            // 1. Visual Active State
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // 2. Trigger Bootstrap Tab Switch
            const targetSelector = btn.getAttribute('data-bs-target');
            const targetPane = document.querySelector(targetSelector);
            
            // Standard Bootstrap 5 Tab trigger
            // We find the trigger element corresponding to this target if it exists, or create a virtual one
            // Simpler: Just remove .active/.show from all panes and add to target
            document.querySelectorAll('.tab-pane').forEach(p => {
                p.classList.remove('show', 'active');
            });
            targetPane.classList.add('show', 'active');
            
            // Special Case: Resize Map if opening map tab
            if (targetSelector === '#map-view' && typeof mapInstance !== 'undefined') {
                setTimeout(() => mapInstance.invalidateSize(), 200);
            }
        }
    </script>
</body>
</html>
